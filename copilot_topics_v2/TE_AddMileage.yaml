kind: AdaptiveDialog
modelDescription: |-
  Add a mileage item to the expense cart.
  Collects miles and calculates reimbursement using the standard rate.
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}
  displayName: Main
  actions:
    # === ENSURE MILEAGE RATE IS SET ===
    - kind: SetVariable
      id: setVariable_InitMileageRate
      displayName: Init Mileage Rate
      variable: Global.MileageRate
      value: =If(IsBlank(Global.MileageRate), 0.70, Global.MileageRate)

    # === COLLECT MILEAGE DETAILS ===
    - kind: Question
      id: question_Miles
      displayName: Ask Miles
      interruptionPolicy:
        allowInterruption: false
      variable: Topic.Miles
      entity: NumberPrebuiltEntity
      prompt: How many miles did you drive (round-trip)?

    # Validate miles
    - kind: ConditionGroup
      id: conditionGroup_ValidateMiles
      displayName: Validate Miles
      conditions:
        - id: conditionItem_InvalidMiles
          condition: =Value(Topic.Miles) <= 0
          displayName: Invalid Miles
          actions:
            - kind: Question
              id: question_MilesRetry
              displayName: Ask Miles Retry
              interruptionPolicy:
                allowInterruption: false
              variable: Topic.Miles
              entity: NumberPrebuiltEntity
              prompt: Miles must be greater than 0. How many miles?

    - kind: Question
      id: question_Description
      displayName: Ask Description
      interruptionPolicy:
        allowInterruption: false
      variable: Topic.Description
      entity: StringPrebuiltEntity
      prompt: |-
        Short description for this trip?
        (e.g., "Office to Denver site")

    # === CALCULATE AMOUNT ===
    - kind: SetVariable
      id: setVariable_Amount
      displayName: Calculate Amount
      variable: Topic.Amount
      value: =Value(Topic.Miles) * Value(Global.MileageRate)

    # === LOOKUP ACCOUNT CODE ===
    - kind: SetVariable
      id: setVariable_ActivityCode
      displayName: Set Activity Code
      variable: Topic.ActivityCode
      value: ="700"

    - kind: BeginDialog
      id: beginDialog_ExpenseCodesLookup
      displayName: Expense Codes Lookup
      dialog: new_agent.action.TravelExpense-ExpenseCodesLookup
      input:
        binding:
          departmentCode: =Global.DepartmentCode
          activityCode: =Topic.ActivityCode
      output:
        binding:
          matches: Topic.Matches

    # Handle account selection
    - kind: ConditionGroup
      id: conditionGroup_HandleMatches
      displayName: Handle Matches
      conditions:
        - id: conditionItem_NoMatches
          condition: =CountRows(Topic.Matches) = 0
          displayName: No Matches
          actions:
            - kind: SendActivity
              id: sendActivity_NoMatches
              displayName: No Matches
              activity: No account codes found for Department {Global.DepartmentCode}. Try "reset" to change department.

            - kind: EndDialog
              id: endDialog_NoMatches
              displayName: End No Matches

        - id: conditionItem_SingleMatch
          condition: =CountRows(Topic.Matches) = 1
          displayName: Single Match
          actions:
            - kind: SetVariable
              id: setVariable_AccountSingle
              displayName: Account Single
              variable: Topic.AccountCode
              value: =First(Topic.Matches).accountCode

      elseActions:
        - kind: SetVariable
          id: setVariable_MatchesList
          displayName: Build Matches List
          variable: Topic.MatchesList
          value: =Concat(Topic.Matches, ThisRecord.accountCode & " - " & ThisRecord.description & Char(10))

        - kind: SendActivity
          id: sendActivity_MultipleMatches
          displayName: Multiple Matches
          activity: |-
            Multiple account codes found:
            {Topic.MatchesList}

        - kind: Question
          id: question_AccountCode
          displayName: Ask Account Code
          interruptionPolicy:
            allowInterruption: false
          variable: Topic.AccountCode
          entity: StringPrebuiltEntity
          prompt: Which account code?

    # === BUILD SUMMARY ===
    - kind: SetVariable
      id: setVariable_Reference
      displayName: Build Reference
      variable: Topic.Reference
      value: =Left(Concatenate("Mileage ", Text(Value(Topic.Miles), "0"), " mi - ", Trim(Topic.Description)), 50)

    - kind: SetVariable
      id: setVariable_AmountFormatted
      displayName: Format Amount
      variable: Topic.AmountFormatted
      value: =Concatenate("$", Text(Value(Topic.Amount), "0.00"))

    - kind: SetVariable
      id: setVariable_RateFormatted
      displayName: Format Rate
      variable: Topic.RateFormatted
      value: =Concatenate("$", Text(Global.MileageRate, "0.00"))

    - kind: SendActivity
      id: sendActivity_Summary
      displayName: Show Summary
      activity: |-
        **Mileage Summary:**
        - Miles: {Topic.Miles}
        - Rate: {Topic.RateFormatted}/mile
        - Total: {Topic.AmountFormatted}
        - Description: {Topic.Description}
        - Department: {Global.DepartmentCode}
        - Account: {Topic.AccountCode}

    # === CONFIRM ADD ===
    - kind: Question
      id: question_Confirm
      displayName: Confirm Add
      interruptionPolicy:
        allowInterruption: false
      variable: Topic.Confirm
      entity: BooleanPrebuiltEntity
      prompt: Add this to your cart? (yes/no)

    - kind: ConditionGroup
      id: conditionGroup_AddToCart
      displayName: Add To Cart
      conditions:
        - id: conditionItem_Confirmed
          condition: =Topic.Confirm = true
          displayName: Confirmed
          actions:
            - kind: SetVariable
              id: setVariable_ReferenceSafe
              displayName: Safe Reference
              variable: Topic.ReferenceSafe
              value: =Substitute(Substitute(Substitute(Topic.Reference, Char(34), "'"), Char(10), " "), Char(13), " ")

            - kind: SetVariable
              id: setVariable_NewItemJson
              displayName: New Item JSON
              variable: Topic.NewItemJson
              value: |-
                =Concatenate(
                  "{",
                  Char(34), "type", Char(34), ":", Char(34), "Mileage", Char(34), ",",
                  Char(34), "miles", Char(34), ":", Text(Value(Topic.Miles), "0"), ",",
                  Char(34), "rate", Char(34), ":", Text(Value(Global.MileageRate), "0.00"), ",",
                  Char(34), "departmentCode", Char(34), ":", Char(34), Global.DepartmentCode, Char(34), ",",
                  Char(34), "activityCode", Char(34), ":", Char(34), Topic.ActivityCode, Char(34), ",",
                  Char(34), "accountCode", Char(34), ":", Char(34), Topic.AccountCode, Char(34), ",",
                  Char(34), "reference", Char(34), ":", Char(34), Topic.ReferenceSafe, Char(34), ",",
                  Char(34), "amount", Char(34), ":", Text(Value(Topic.Amount), "0.00"),
                  "}"
                )

            - kind: SetVariable
              id: setVariable_AppendToCart
              displayName: Append To Cart
              variable: Global.CartJson
              value: |-
                =If(
                  IsBlank(Global.CartJson) || Global.CartJson = "[]",
                  Concatenate("[", Topic.NewItemJson, "]"),
                  Concatenate(Left(Global.CartJson, Len(Global.CartJson) - 1), ",", Topic.NewItemJson, "]")
                )

            - kind: SetVariable
              id: setVariable_IncrementCount
              displayName: Increment Cart Count
              variable: Global.CartCount
              value: =If(IsBlank(Global.CartCount), 0, Global.CartCount) + 1

            - kind: SendActivity
              id: sendActivity_Added
              displayName: Item Added
              activity: |-
                Added to cart. ({Global.CartCount} items)

                Say "add receipt", "add per diem", "add mileage", "review", or "submit".

      elseActions:
        - kind: SendActivity
          id: sendActivity_NotAdded
          displayName: Not Added
          activity: |-
            OK, not added.

            Say "add mileage" to try again.

    - kind: EndDialog
      id: endDialog_Main
      displayName: End

inputType: {}
outputType: {}
