kind: AdaptiveDialog
modelDescription: |-
  Main entry point for Travel Expense Bot.
  Collects user email, looks up department code via Azure function, then routes to item topics.
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - help
      - start
      - travel expense
      - expense report
      - add receipt
      - receipt
      - add per diem
      - per diem
      - perdiem
      - add mileage
      - mileage
      - miles
      - review
      - review cart
      - submit
      - send
      - reset
      - clear
      - debug

  displayName: Main
  actions:
    # === INITIALIZE GLOBALS ===
    - kind: SetVariable
      id: setVariable_Version
      displayName: Set Version
      variable: Global.Version
      value: ="2.0.0"

    - kind: SetVariable
      id: setVariable_InitApiBaseUrl
      displayName: Init API Base URL
      variable: Global.ApiBaseUrl
      value: =If(IsBlank(Global.ApiBaseUrl), "https://departmentcodes-gnfncpgxdueyfdh9.eastus2-01.azurewebsites.net", Global.ApiBaseUrl)

    - kind: SetVariable
      id: setVariable_InitMileageRate
      displayName: Init Mileage Rate
      variable: Global.MileageRate
      value: =If(IsBlank(Global.MileageRate), 0.70, Global.MileageRate)

    - kind: SetVariable
      id: setVariable_InitCart
      displayName: Init Cart
      variable: Global.CartJson
      value: =If(IsBlank(Global.CartJson), "[]", Global.CartJson)

    - kind: SetVariable
      id: setVariable_InitCartCount
      displayName: Init Cart Count
      variable: Global.CartCount
      value: =If(IsBlank(Global.CartCount), 0, Global.CartCount)

    # === NORMALIZE USER INPUT ===
    - kind: SetVariable
      id: setVariable_UserInput
      displayName: Normalize User Input
      variable: Topic.UserInput
      value: =Lower(Trim(Coalesce(System.Activity.Text, "")))

    # === CHECK FOR RESET ===
    - kind: ConditionGroup
      id: conditionGroup_Reset
      displayName: Check Reset
      conditions:
        - id: conditionItem_Reset
          condition: =Find("reset", Topic.UserInput) > 0 || Find("clear", Topic.UserInput) > 0
          displayName: Reset Requested
          actions:
            - kind: SetVariable
              id: setVariable_ClearEmail
              displayName: Clear Email
              variable: Global.RequesterEmail
              value: =""

            - kind: SetVariable
              id: setVariable_ClearDept
              displayName: Clear Dept
              variable: Global.DepartmentCode
              value: =""

            - kind: SetVariable
              id: setVariable_ClearCart
              displayName: Clear Cart
              variable: Global.CartJson
              value: ="[]"

            - kind: SetVariable
              id: setVariable_ClearCartCount
              displayName: Clear Cart Count
              variable: Global.CartCount
              value: =0

            - kind: SendActivity
              id: sendActivity_ResetDone
              displayName: Reset Done
              activity: |-
                Reset complete. Your cart is empty.

                Say "add receipt", "add per diem", or "add mileage" to start.

            - kind: EndDialog
              id: endDialog_Reset
              displayName: End After Reset

    # === COLLECT EMAIL IF NOT SET ===
    - kind: ConditionGroup
      id: conditionGroup_CollectEmail
      displayName: Collect Email
      conditions:
        - id: conditionItem_EmailMissing
          condition: =IsBlank(Global.RequesterEmail) || Len(Trim(Global.RequesterEmail)) = 0
          displayName: Email Missing
          actions:
            - kind: SetVariable
              id: setVariable_TeamsEmail
              displayName: Get Teams Email
              variable: Topic.TeamsEmail
              value: =Lower(Trim(Coalesce(System.User.Email, "")))

            - kind: Question
              id: question_Email
              displayName: Ask Email
              interruptionPolicy:
                allowInterruption: false
              variable: Topic.EmailInput
              entity: StringPrebuiltEntity
              prompt: |-
                What is your CORE email address?
                (Type "me" to use your signed-in email)

            - kind: SetVariable
              id: setVariable_ProcessEmail
              displayName: Process Email Input
              variable: Global.RequesterEmail
              value: =If(Lower(Trim(Topic.EmailInput)) = "me", Topic.TeamsEmail, Lower(Trim(Topic.EmailInput)))

            # Validate email format
            - kind: ConditionGroup
              id: conditionGroup_ValidateEmail
              displayName: Validate Email
              conditions:
                - id: conditionItem_InvalidEmail
                  condition: =IsBlank(Global.RequesterEmail) || Find("@", Global.RequesterEmail) <= 0
                  displayName: Invalid Email
                  actions:
                    - kind: Question
                      id: question_EmailRetry
                      displayName: Ask Email Retry
                      interruptionPolicy:
                        allowInterruption: false
                      variable: Topic.EmailInput
                      entity: StringPrebuiltEntity
                      prompt: Please enter a valid email address (e.g., name@core.coop).

                    - kind: SetVariable
                      id: setVariable_ProcessEmailRetry
                      displayName: Process Email Retry
                      variable: Global.RequesterEmail
                      value: =If(Lower(Trim(Topic.EmailInput)) = "me", Topic.TeamsEmail, Lower(Trim(Topic.EmailInput)))

    # === LOOKUP DEPARTMENT CODE IF NOT SET ===
    - kind: ConditionGroup
      id: conditionGroup_LookupDept
      displayName: Lookup Department
      conditions:
        - id: conditionItem_DeptMissing
          condition: =IsBlank(Global.DepartmentCode) || Len(Trim(Global.DepartmentCode)) = 0
          displayName: Dept Missing
          actions:
            - kind: SendActivity
              id: sendActivity_LookingUp
              displayName: Looking Up
              activity: Looking up your department...

            # Initialize lookup variables
            - kind: SetVariable
              id: setVariable_InitLookupOk
              displayName: Init Lookup Ok
              variable: Topic.LookupOk
              value: =false

            - kind: SetVariable
              id: setVariable_InitLookupDept
              displayName: Init Lookup Dept
              variable: Topic.LookupDeptCode
              value: =""

            # Call OrgChart Lookup
            - kind: BeginDialog
              id: beginDialog_OrgChartLookup
              displayName: OrgChart Lookup
              dialog: new_agent.action.TravelExpense-OrgChartLookupByUpn
              input:
                binding:
                  upn: =Global.RequesterEmail
              output:
                binding:
                  ok: Topic.LookupOk
                  found: Topic.LookupFound
                  departmentCode: Topic.LookupDeptCode
                  departmentName: Topic.LookupDeptName
                  error: Topic.LookupError

            # Check lookup result
            - kind: ConditionGroup
              id: conditionGroup_CheckLookup
              displayName: Check Lookup Result
              conditions:
                - id: conditionItem_LookupSuccess
                  condition: =Topic.LookupOk = true && Topic.LookupFound = true && !IsBlank(Topic.LookupDeptCode)
                  displayName: Lookup Success
                  actions:
                    - kind: SetVariable
                      id: setVariable_SetDeptFromLookup
                      displayName: Set Dept From Lookup
                      variable: Global.DepartmentCode
                      value: =Topic.LookupDeptCode

                    - kind: SetVariable
                      id: setVariable_SetDeptName
                      displayName: Set Dept Name
                      variable: Global.DepartmentName
                      value: =Coalesce(Topic.LookupDeptName, "")

                    - kind: SendActivity
                      id: sendActivity_DeptFound
                      displayName: Dept Found
                      activity: "Found department: {Global.DepartmentCode} - {Global.DepartmentName}"

              elseActions:
                # Fallback: ask for department code manually
                - kind: SendActivity
                  id: sendActivity_DeptNotFound
                  displayName: Dept Not Found
                  activity: I couldn't find your department automatically.

                - kind: Question
                  id: question_DeptCode
                  displayName: Ask Dept Code
                  interruptionPolicy:
                    allowInterruption: false
                  variable: Topic.DeptInput
                  entity: StringPrebuiltEntity
                  prompt: "What is your 3-digit department code? (e.g., 620)"

                - kind: SetVariable
                  id: setVariable_ExtractDeptCode
                  displayName: Extract Dept Code
                  variable: Global.DepartmentCode
                  value: =Coalesce(Match(Trim(Topic.DeptInput), "[0-9]{3}").FullMatch, "")

                # Validate dept code
                - kind: ConditionGroup
                  id: conditionGroup_ValidateDept
                  displayName: Validate Dept
                  conditions:
                    - id: conditionItem_InvalidDept
                      condition: =!IsMatch(Global.DepartmentCode, "^[0-9]{3}$")
                      displayName: Invalid Dept
                      actions:
                        - kind: Question
                          id: question_DeptCodeRetry
                          displayName: Ask Dept Code Retry
                          interruptionPolicy:
                            allowInterruption: false
                          variable: Topic.DeptInput
                          entity: StringPrebuiltEntity
                          prompt: "Department code must be 3 digits. Please enter your department code (e.g., 620):"

                        - kind: SetVariable
                          id: setVariable_ExtractDeptCodeRetry
                          displayName: Extract Dept Code Retry
                          variable: Global.DepartmentCode
                          value: =Coalesce(Match(Trim(Topic.DeptInput), "[0-9]{3}").FullMatch, "")

    # === SHOW CONTEXT SUMMARY ===
    - kind: ConditionGroup
      id: conditionGroup_Debug
      displayName: Check Debug
      conditions:
        - id: conditionItem_Debug
          condition: =Find("debug", Topic.UserInput) > 0
          displayName: Debug Requested
          actions:
            - kind: SendActivity
              id: sendActivity_Debug
              displayName: Debug Info
              activity: |-
                **Debug Info:**
                - Version: {Global.Version}
                - Email: {Global.RequesterEmail}
                - Department: {Global.DepartmentCode}
                - Cart Items: {Global.CartCount}

            - kind: EndDialog
              id: endDialog_Debug
              displayName: End After Debug

    # === ROUTE TO ITEM TOPICS ===
    - kind: ConditionGroup
      id: conditionGroup_Route
      displayName: Route to Topic
      conditions:
        # Per Diem
        - id: conditionItem_PerDiem
          condition: =Find("per diem", Topic.UserInput) > 0 || Find("perdiem", Topic.UserInput) > 0
          displayName: Route Per Diem
          actions:
            - kind: BeginDialog
              id: beginDialog_AddPerDiem
              displayName: Add Per Diem
              dialog: new_agent.topic.TE_AddPerDiem
              input: {}
              output: {}

            - kind: EndDialog
              id: endDialog_PerDiem
              displayName: End Per Diem

        # Receipt
        - id: conditionItem_Receipt
          condition: =Find("receipt", Topic.UserInput) > 0
          displayName: Route Receipt
          actions:
            - kind: BeginDialog
              id: beginDialog_AddReceipt
              displayName: Add Receipt
              dialog: new_agent.topic.TE_AddReceipt
              input: {}
              output: {}

            - kind: EndDialog
              id: endDialog_Receipt
              displayName: End Receipt

        # Mileage
        - id: conditionItem_Mileage
          condition: =Find("mileage", Topic.UserInput) > 0 || Find("miles", Topic.UserInput) > 0
          displayName: Route Mileage
          actions:
            - kind: BeginDialog
              id: beginDialog_AddMileage
              displayName: Add Mileage
              dialog: new_agent.topic.TE_AddMileage
              input: {}
              output: {}

            - kind: EndDialog
              id: endDialog_Mileage
              displayName: End Mileage

        # Review
        - id: conditionItem_Review
          condition: =Find("review", Topic.UserInput) > 0
          displayName: Route Review
          actions:
            - kind: BeginDialog
              id: beginDialog_ReviewCart
              displayName: Review Cart
              dialog: new_agent.topic.TE_ReviewCart
              input: {}
              output: {}

            - kind: EndDialog
              id: endDialog_Review
              displayName: End Review

        # Submit
        - id: conditionItem_Submit
          condition: =Find("submit", Topic.UserInput) > 0 || Find("send", Topic.UserInput) > 0
          displayName: Route Submit
          actions:
            - kind: BeginDialog
              id: beginDialog_Submit
              displayName: Submit
              dialog: new_agent.topic.TE_Submit
              input: {}
              output: {}

            - kind: EndDialog
              id: endDialog_Submit
              displayName: End Submit

    # === DEFAULT: SHOW HELP ===
    - kind: SendActivity
      id: sendActivity_Help
      displayName: Show Help
      activity: |-
        **Travel Expense Bot** (v{Global.Version})

        Email: {Global.RequesterEmail}
        Department: {Global.DepartmentCode}
        Cart Items: {Global.CartCount}

        **Commands:**
        - "add receipt" - Add a receipt expense
        - "add per diem" - Add per diem for travel
        - "add mileage" - Add mileage reimbursement
        - "review" - Review your cart
        - "submit" - Submit your expense report
        - "reset" - Clear everything and start over

    - kind: EndDialog
      id: endDialog_Main
      displayName: End Main

inputType: {}
outputType: {}
